<div class="company-users-container">
  @if (companySignal(); as company) {
    <div class="header">
      <div>
        <button class="back-button" (click)="goBack()" aria-label="Volver a lista de compañías">
          ← Volver
        </button>
        <h2 class="title">{{ company.name }}</h2>
        <p class="subtitle">Usuarios asignados a esta compañía</p>
      </div>
      <button 
        class="btn-primary"
        (click)="toggleAddForm()"
        [attr.aria-label]="showAddFormSignal() ? 'Cancelar asignación' : 'Asignar nuevo usuario'">
        {{ showAddFormSignal() ? 'Cancelar' : '+ Asignar Usuario' }}
      </button>
    </div>

    @if (errorSignal()) {
      <div class="error-banner" role="alert">
        {{ errorSignal() }}
      </div>
    }

    @if (showAddFormSignal()) {
      <div class="add-user-form">
        <h3 class="form-title">Asignar Usuario a Compañía</h3>
        <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
          <div class="form-row">
            <div class="form-group">
              <label for="userId" class="form-label">
                ID de Usuario <span class="required">*</span>
              </label>
              <input
                id="userId"
                type="text"
                formControlName="userId"
                class="form-input"
                placeholder="user-123"
                aria-describedby="userId-help"
              />
              <span id="userId-help" class="help-text">
                Ingrese el ID del usuario a asignar
              </span>
            </div>

            <div class="form-group">
              <label for="role" class="form-label">
                Rol <span class="required">*</span>
              </label>
              <select
                id="role"
                formControlName="role"
                class="form-select"
                aria-label="Seleccionar rol del usuario">
                <option [value]="CompanyUserRole.EMPLOYEE">{{ CompanyUserRole.EMPLOYEE }}</option>
                <option [value]="CompanyUserRole.ADMIN">{{ CompanyUserRole.ADMIN }}</option>
              </select>
            </div>

            <div class="form-actions">
              <button
                type="submit"
                class="btn-primary"
                [disabled]="userForm.invalid || isSubmittingSignal()"
                aria-label="Asignar usuario">
                {{ isSubmittingSignal() ? 'Asignando...' : 'Asignar' }}
              </button>
            </div>
          </div>
        </form>
      </div>
    }

    <div class="users-section">
      @if (companyUsersSignal().length === 0) {
        <div class="empty-state">
          <p>No hay usuarios asignados a esta compañía.</p>
          <button class="btn-primary" (click)="toggleAddForm()">
            Asignar Primer Usuario
          </button>
        </div>
      } @else {
        <div class="users-table-container">
          <table class="users-table">
            <thead>
              <tr>
                <th scope="col">Usuario</th>
                <th scope="col">Email</th>
                <th scope="col">Rol</th>
                <th scope="col">Asignado por</th>
                <th scope="col">Fecha de asignación</th>
                <th scope="col">Acciones</th>
              </tr>
            </thead>
            <tbody>
              @for (user of companyUsersSignal(); track trackByUserId($index, user)) {
                <tr>
                  <td class="user-name">{{ user.userName }}</td>
                  <td class="user-email">{{ user.userEmail }}</td>
                  <td>
                    <select
                      [value]="user.role"
                      (change)="updateRole(user, $event)"
                      class="role-select"
                      [attr.aria-label]="'Cambiar rol de ' + user.userName">
                      <option [value]="CompanyUserRole.EMPLOYEE">{{ CompanyUserRole.EMPLOYEE }}</option>
                      <option [value]="CompanyUserRole.ADMIN">{{ CompanyUserRole.ADMIN }}</option>
                    </select>
                  </td>
                  <td>{{ user.assignedBy }}</td>
                  <td>{{ user.assignedAt | date:'short' }}</td>
                  <td>
                    <button
                      class="btn-danger-small"
                      (click)="removeUser(user)"
                      [attr.aria-label]="'Remover a ' + user.userName">
                      Remover
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </div>
  } @else {
    <div class="loading">
      <p>Cargando...</p>
    </div>
  }
</div>
